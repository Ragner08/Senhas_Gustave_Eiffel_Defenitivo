@model Meal
@{
    ViewData["Title"] = "Detalhes do Dia";
    var date = (DateTime)ViewBag.Date;
    var isFuncionario = (bool)ViewBag.IsFuncionario;
    var isPast = (bool)ViewBag.IsPast;
    var isToday = date.Date == DateTime.Today;
    var isPastOrToday = isPast || isToday;
    var hasBooking = (bool)ViewBag.HasBooking;
    var hasMeal = (bool)ViewBag.HasMeal;
    var userEscalao = (string)ViewBag.UserEscalao;
    var walletBalance = (decimal)ViewBag.WalletBalance;
    var price = (decimal)ViewBag.Price;
}

<div class="container mt-4">
    <div class="day-details-header">
        <h2>
            <i class="bi bi-calendar-day"></i>
            @date.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("pt-PT"))
        </h2>
        <a asp-action="Index" asp-route-year="@date.Year" asp-route-month="@date.Month" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i>
            Voltar ao Calendário
        </a>
    </div>

    <div class="row">
        <!-- Refeição do Dia -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-utensils me-2"></i>Refeição do Dia
                    </h5>
                </div>
                <div class="card-body">
                    @if (hasMeal)
                    {
                        <div class="meal-details">
                            @if (!string.IsNullOrEmpty(Model.Sopa))
                            {
                                <div class="meal-item">
                                    <div class="meal-icon"><i class="bi bi-cup-hot"></i></div>
                                    <div class="meal-content">
                                        <span class="meal-label">Sopa</span>
                                        <span class="meal-value">@Model.Sopa</span>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.PratoPrincipal))
                            {
                                <div class="meal-item">
                                    <div class="meal-icon"><i class="bi bi-egg-fried"></i></div>
                                    <div class="meal-content">
                                        <span class="meal-label">Prato Principal</span>
                                        <span class="meal-value">@Model.PratoPrincipal</span>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.Vegetariano))
                            {
                                <div class="meal-item">
                                    <div class="meal-icon"><i class="bi bi-flower1"></i></div>
                                    <div class="meal-content">
                                        <span class="meal-label">Opção Vegetariana</span>
                                        <span class="meal-value">@Model.Vegetariano</span>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.Sobremesa))
                            {
                                <div class="meal-item">
                                    <div class="meal-icon"><i class="bi bi-cake"></i></div>
                                    <div class="meal-content">
                                        <span class="meal-label">Sobremesa</span>
                                        <span class="meal-value">@Model.Sobremesa</span>
                                    </div>
                                </div>
                            }
                        </div>

                        <hr class="my-4" />

                        <h6 class="mb-3"><i class="bi bi-cash me-2"></i>Preços</h6>
                        <div class="prices-grid">
                            <div class="price-box @(userEscalao == "Escalão A" ? "active" : "")">
                                <span class="price-label">Escalão A</span>
                                <span class="price-value">@Model.PrecoEscalaoA.ToString("C")</span>
                            </div>
                            <div class="price-box @(userEscalao == "Escalão B" ? "active" : "")">
                                <span class="price-label">Escalão B</span>
                                <span class="price-value">@Model.PrecoEscalaoB.ToString("C")</span>
                            </div>
                            <div class="price-box @(userEscalao == "Sem escalão" ? "active" : "")">
                                <span class="price-label">Sem Escalão</span>
                                <span class="price-value">@Model.PrecoSemEscalao.ToString("C")</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                            <p class="mt-3">Nenhuma refeição definida para este dia.</p>
                            @if (isFuncionario && !isPastOrToday)
                            {
                                <a asp-action="CreateMeal" asp-route-date="@date.ToString("yyyy-MM-dd")" class="btn btn-primary mt-2">
                                    <i class="bi bi-plus-circle me-2"></i>Definir Refeição
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Ações -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-ticket-perforated me-2"></i>Ações
                    </h5>
                </div>
                <div class="card-body">
                    @if (isPastOrToday)
                    {
                        <div class="alert alert-secondary">
                            <i class="bi bi-clock-history me-2"></i>
                            @if (isToday)
                            {
                                <strong>Não é possível marcar para hoje.</strong>
                                <p class="mb-0 mt-2">As marcações devem ser feitas com antecedência.</p>
                            }
                            else
                            {
                                <strong>Este dia já passou.</strong>
                                <p class="mb-0 mt-2">Não é possível realizar marcações para datas passadas.</p>
                            }
                        </div>
                    }
                    else if (hasBooking)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Senha já marcada!</strong>
                            <p class="mb-0 mt-2">Já tem uma senha marcada para este dia.</p>
                        </div>
                    }
                    else if (!hasMeal)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Refeição não disponível</strong>
                            <p class="mb-0 mt-2">Aguarde até que a refeição seja definida.</p>
                        </div>
                    }
                    else
                    {
                        <div class="booking-info">
                            <div class="info-row">
                                <span class="info-label">Saldo na Carteira:</span>
                                <span class="info-value @(walletBalance >= price ? "text-success" : "text-danger")">
                                    @walletBalance.ToString("C")
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Preço (@userEscalao):</span>
                                <span class="info-value text-primary">@price.ToString("C")</span>
                            </div>
                        </div>

                        @if (walletBalance >= price)
                        {
                            <form asp-action="BookMeal" method="post" class="mt-3">
                                <input type="hidden" name="date" value="@date.ToString("yyyy-MM-dd")" />
                                <input type="hidden" name="escalao" value="@userEscalao" />
                                <button type="submit" class="btn btn-success w-100 btn-lg">
                                    <i class="bi bi-check-circle me-2"></i>Marcar Senha
                                </button>
                            </form>
                        }
                        else
                        {
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                Saldo insuficiente!
                            </div>
                            <a asp-controller="Wallet" asp-action="AddFunds" class="btn btn-primary w-100 mt-2">
                                <i class="bi bi-plus-circle me-2"></i>Carregar Carteira
                            </a>
                        }
                    }

                    @if (isFuncionario && hasMeal && !isPastOrToday)
                    {
                        <hr class="my-3" />
                        <h6 class="mb-2"><i class="bi bi-gear me-2"></i>Ações de Funcionário</h6>
                        <a asp-action="EditMeal" asp-route-id="@Model.Id" class="btn btn-outline-primary w-100">
                            <i class="bi bi-pencil me-2"></i>Editar Refeição
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
